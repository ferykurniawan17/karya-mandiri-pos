// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./pos.db"
}

model User {
  id            String          @id @default(uuid())
  username      String          @unique
  password      String
  name          String
  role          String          @default("cashier")
  createdAt     DateTime        @default(now())
  transactions  Transaction[]
  purchaseOrders PurchaseOrder[]
}

model Category {
  id          String    @id @default(uuid())
  name        String
  description String?
  products    Product[]
  createdAt   DateTime  @default(now())
}

model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  products  Product[]
}

model Brand {
  id        String    @id @default(uuid())
  name      String    @unique
  photo     String?
  createdAt DateTime  @default(now())
  products  Product[]
}

model Customer {
  id          String        @id @default(uuid())
  name        String
  type        String        // "individual" or "institution"
  phone       String?
  email       String?
  address     String?
  notes       String?
  projects    Project[]
  transactions Transaction[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Project {
  id          String        @id @default(uuid())
  name        String
  customerId  String
  customer    Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  isDefault   Boolean       @default(false)  // Default project untuk customer
  description String?
  transactions Transaction[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@unique([customerId, name])  // Nama project unique per customer
}

model Product {
  id                String              @id @default(uuid())
  name              String
  aliasName         String?
  sku               String?             @unique
  stock             Int                 @default(0)
  minimalStock      Int                 @default(0)
  unit              String
  purchasePrice     Decimal?            // Optional, harga dari PO
  sellingPrice      Decimal
  photo             String?
  placement         String?
  categoryId        String
  category          Category            @relation(fields: [categoryId], references: [id])
  brandId           String?
  brand             Brand?              @relation(fields: [brandId], references: [id])
  tags              Tag[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  transactionItems TransactionItem[]
  purchaseOrderItems PurchaseOrderItem[]
}

model Transaction {
  id            String            @id @default(uuid())
  invoiceNo     String            @unique
  total         Decimal
  cash          Decimal           // Jumlah yang dibayar tunai
  credit        Decimal           @default(0)  // Jumlah yang dihutang
  change        Decimal           @default(0)
  paymentStatus String            @default("paid")  // "paid", "unpaid", "partial"
  paymentMethod String?           // "cash", "transfer", "credit", "mixed"
  customerId    String?
  customer      Customer?         @relation(fields: [customerId], references: [id])
  projectId     String?
  project       Project?          @relation(fields: [projectId], references: [id])
  projectName   String?           // Keep for backward compatibility
  note          String?
  userId        String
  user          User              @relation(fields: [userId], references: [id])
  items         TransactionItem[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now()) @updatedAt
}

model TransactionItem {
  id            String      @id @default(uuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  quantity      Int
  price         Decimal
  subtotal      Decimal
  status        String?     // "diambil" or "dikirim"
}

model Provider {
  id            String          @id @default(uuid())
  name          String
  phone         String?
  email         String?
  address       String?
  notes         String?
  purchaseOrders PurchaseOrder[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model PurchaseOrder {
  id            String              @id @default(uuid())
  poNumber      String              @unique  // Auto-generated: PO-YYYYMMDD-XXXXX
  providerId    String?
  provider      Provider?           @relation(fields: [providerId], references: [id])
  status        String              @default("draft")  // "draft", "approved", "received", "cancelled"
  total         Decimal             @default(0)
  note          String?
  userId        String
  user          User                @relation(fields: [userId], references: [id])
  items         PurchaseOrderItem[]
  receivedAt    DateTime?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

model PurchaseOrderItem {
  id              String          @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product         @relation(fields: [productId], references: [id])
  quantity        Int
  purchasePrice   Decimal         // Harga beli dari PO ini
  subtotal        Decimal
  receivedQuantity Int            @default(0)  // Jumlah yang sudah diterima
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

